# Metadata server

Metadata server aims to provide metadata management for your libraries, so as to better understand the relevant information of your libraries.

## Deployment

!!! note "Prerequisites"
    The startup of Metadata server requires using ***Redis*** as the cached server (it should be the default cached server in Seafile 13.0). So you must deploy *Redis* for Seafile, then modify [`seafile.conf`](../config/seafile-conf.md#cache-pro-edition-only), [`seahub_settings.py`](https://docs.djangoproject.com/en/4.2/topics/cache/#redis) and [`seafevents.conf`](../config/seafevents-conf.md) to enable it before deploying metadata server.

### Download YML file

Please download YML file **in your `seafile-server.yml` directory** by following command:

=== "Deploy in the same machine with Seafile"

    ```sh
    wget https://manual.seafile.com/13.0/repo/docker/md-server.yml
    ```

=== "Standalone"

    ```sh
    wget https://manual.seafile.com/13.0/repo/docker/metadata-server/md-server.yml
    wget -O .env https://manual.seafile.com/13.0/repo/docker/metadata-server/env
    ```

    !!! warning "Important for standalone deployment"
        Starting from Seafile 13.0, metadata server supports standalone deployment, but it still needs to maintain access to the original Seafile data directory. **Please make sure that the machine where metadata server is deployed can access the directory normally**.

### Modify `.env`

!!! success "Faster configuration"
    Metadata-server docker we use an one-time configuration file, which will be generated directly through the environment variable, eliminating the need for you to repeatedly write configuration files (i.e., **no `md-server.conf`**), which will significantly improve your deployment efficiency.

Normally, you only need to set a `METADATA_SERVER_SECRET_KEY` for the metadata server in `.env`, and the metadata of the library will be stored locally (default is `opt/md-data`):

```env
METADATA_SERVER_SECRET_KEY=<your metadata server secret key>
MD_DATA=/opt/md-data
```

!!! warning "About `METADATA_SERVER_SECRET_KEY`"
    It is used to Seafile connect to metadata server, which can be generated by `pwgen -s 40 1`. However, we **do not recommend** to use the same as the original `JWT_PRIVATE_KEY` in `.env` **for security reasons**.

The following table is all the related environment variables with metadata-server:

| Variables           | Description                                                                                                                | Required |
| --- | --- | --- |
| `METADATA_SERVER_SECRET_KEY`   | The JWT key used to connect with Seafile server | **Required** |
| `MD_STORAGE_TYPE`   | The type of backend storage. Options: `file` (local storage), `s3`, `oss`.                                                 | Optional, default `file`            |
| `MD_DATA`           | Directory where local data (only valid in `MD_STORAGE_TYPE=file`) and cache are located.                                  | Optional, default `/opt/md-data`   |
| `SEAFILE_VOLUME`           | Directory for Seafile data | Optional, default `/opt/seafile-data`   |
| `MD_MAX_CACHE_SIZE` | The maximum cache size.                                                                                                    | Optional, default `1GB`            |
| `MD_S3_HOST`        | Host of s3 backend.                                                                                                        | Optional                |
| `MD_S3_AWS_REGION`  | Region of *AWS* s3 backend.                                                                                                | Optional                |
| `MD_S3_USE_HTTPS`   | Use https connecting to S3 backend.                                                                                        | Optional, default `true`          |
| `MD_S3_BUCKET`      | Name of S3 bucket for storaging metadata.                                                                                 |  **Required**  when `MD_STORAGE_TYPE=s3` |
| `MD_S3_PATH_STYLE_REQUEST` | S3 backend use path style request.                                                                                 | Optional, default `false`          |
| `MD_S3_KEY_ID`      | S3 backend authorization key ID.                                                                                           | **Required**  when `MD_STORAGE_TYPE=s3` |
| `MD_S3_KEY`         | S3 backend authorization key secret.                                                                                       |  **Required**  when `MD_STORAGE_TYPE=s3` |
| `MD_S3_USE_V4_SIGNATURE` | Use V4 signature to S3 storage backend.                                                                              | Optional, default `true`           |
| `MD_S3_SSE_C_KEY`   | S3 SSE-C key.                                                                                                              | Optional                |
| `MD_OSS_HOST`       | OSS backend host.                                                                                                          | Optional                |
| `MD_OSS_REGION`     | OSS backend region.                                                                                                        | Optional                |
| `MD_OSS_BUCKET`     | Name of OSS bucket for storaging metadata.                                                                               | **Required**  when `MD_STORAGE_TYPE=oss` |
| `MD_OSS_KEY_ID`     | OSS backend authorization key ID.                                                                                          | **Required**  when `MD_STORAGE_TYPE=oss` |
| `MD_OSS_KEY`        | OSS backend authorization key secret.                                                                                      | **Required**  when `MD_STORAGE_TYPE=oss` |
| `REDIS_HOST`        | Your *Redis* service host.                                                                                                 | Optional, default `redis`          |
| `REDIS_PORT`        | Your *Redis* service port.                                                                                                 | Optional, default `6379`           |
| `REDIS_PASSWORD`    | Your *Redis* access password.                                                                                              | Optional                |
    

!!! tip "More descriptions about *Optional* and *Required* in above table"
    - In the table above, although many items are marked as *Required*, some of them are only required when the storage backend specified by `MD_STORAGE_TYPE` is used:
        - `MD_S3_xxx` only valid in `MD_STORAGE_TYPE=s3`
        - `MD_OSS_xxx` only valid in `MD_STORAGE_TYPE=oss`

    - If `MD_STORAGE_TYPE` is `s3` or `oss`, although `MD_xxx_HOST` and `MD_xxx_REGION` are marked as ***Optional***, when you use one of these two storage backends, **you must specify at least one of `MD_xxx_HOST` and `MD_xxx_REGION`, otherwise the service will fail to start**.

### Modify `seahub_settings.py`

To enable metadata server in Seafile, please add the following field in your `seahub_settings.py`:

=== "Deploy in the same machine with Seafile"
    ```py
    ENABLE_METADATA_MANAGEMENT = True
    METADATA_SERVER_SECRET_KEY = '<your metadata server secret key> '
    METADATA_SERVER_URL = 'http://metadata-server:8084'
    ```
=== "Standalone"
    ```py
    ENABLE_METADATA_MANAGEMENT = True
    METADATA_SERVER_SECRET_KEY = '<your metadata server secret key> '
    METADATA_SERVER_URL = 'http://<your metadata-server host>:8084'
    ```

## Start service

You can use following command to start metadata server (and the Seafile service also have to restart):

```sh
docker compose up -d
```

!!! success
    If the container startups normally, the message you can get from the following logs
    
    - `docker logs -f metadata-server`:
        ```log
        [md-server] [2025-01-24 06:23:44] [INFO] Environment variable validity checked
        [md-server] [2025-01-24 06:23:44] [INFO] Database initialization completed
        [md-server] [2025-01-24 06:23:44] [INFO] Configuration file generated
        ```
    - `$MD_DATA/log/seaf-md-server.log`
        ```log
        [2025-02-23 06:07:57] [INFO] starting seaf-md-server
        ```
    - `$SEAFILE_VOLUME/seafile/logs/seafevents.log`
        ```log
        [2025-02-23 06:08:05] [INFO] seafevents.repo_metadata.index_worker:134 refresh_lock refresh_thread Starting refresh locks
        [2025-02-23 06:08:05] [INFO] seafevents.repo_metadata.slow_task_handler:61 worker_handler slow_task_handler_thread_0 starting update metadata work
        [2025-02-23 06:08:05] [INFO] seafevents.repo_metadata.slow_task_handler:61 worker_handler slow_task_handler_thread_1 starting update metadata work
        [2025-02-23 06:08:05] [INFO] seafevents.repo_metadata.slow_task_handler:61 worker_handler slow_task_handler_thread_2 starting update metadata work
        ```
`
